{% extends 'base.html' %}

{% block title %}Add Medical Record - {{ pet.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <div class="card shadow border-0 overflow-hidden">
                <div class="card-header bg-primary text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0"><i class="bi bi-file-medical"></i> New Medical Record</h4>
                            <p class="mb-0 small">Patient: <strong>{{ pet.name }}</strong> ({{ pet.breed }})</p>
                        </div>
                        <i class="bi bi-hospital" style="font-size: 2rem; opacity: 0.2;"></i>
                    </div>
                </div>
                <div class="card-body p-4 p-md-5">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row g-4">
                            <!-- Basic Visit Info -->
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Visit Type</label>
                                {{ form.visit_type }}
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Symptoms</label>
                                {{ form.symptoms }}
                            </div>

                            <!-- Vitals Section -->
                            <div class="col-12">
                                <hr class="my-4 opacity-50">
                                <h5 class="mb-3 text-primary"><i class="bi bi-activity"></i> Vital Signs</h5>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label small fw-bold">Temperature (Â°F)</label>
                                        {{ form.temperature }}
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small fw-bold">Heart Rate (BPM)</label>
                                        {{ form.heart_rate }}
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small fw-bold">Resp. Rate (/min)</label>
                                        {{ form.respiratory_rate }}
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small fw-bold">Weight (kg)</label>
                                        {{ form.weight }}
                                    </div>
                                </div>
                            </div>

                            <!-- Diagnosis & Treatment -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">Diagnosis</label>
                                {{ form.diagnosis }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">Treatment Plan</label>
                                {{ form.treatment }}
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Clinical Notes</label>
                                {{ form.notes }}
                            </div>

                            <!-- Prescription Builder -->
                            <div class="col-12">
                                <hr class="my-4 opacity-50">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0 text-primary"><i class="bi bi-prescription2"></i> Prescriptions</h5>
                                    <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#prescriptionModal">
                                        <i class="bi bi-plus"></i> Add Medication
                                    </button>
                                </div>
                                
                                <div id="prescription_list" class="row g-3">
                                    <!-- Dynamic list of prescriptions will appear here -->
                                    <div class="col-12 text-center py-4 bg-light rounded-4 border-dashed border-2 text-secondary" id="no_prescriptions_msg" style="border: 2px dashed #ccc !important;">
                                        <i class="bi bi-capsule fs-2 d-block mb-2"></i>
                                        <small>No medications prescribed for this visit.</small>
                                    </div>
                                </div>
                                <input type="hidden" name="prescriptions_json" id="prescriptions_json" value="[]">
                            </div>

                            <!-- Follow up -->
                            <div class="col-12">
                                <div class="p-3 rounded stats-section">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <div class="form-check form-switch">
                                                {{ form.follow_up_required }}
                                                <label class="form-check-label fw-bold" for="{{ form.follow_up_required.id_for_label }}">
                                                    Follow-up Visit Required
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6" id="follow_up_date_container">
                                            <label class="form-label small fw-bold">Follow-up Date</label>
                                            {{ form.follow_up_date }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-5 d-flex gap-3">
                            <button type="submit" class="btn btn-primary px-5 py-2">
                                <i class="bi bi-cloud-check"></i> Save Record
                            </button>
                            <a href="{% url 'medical_records:pet_detail' pet.pk %}" class="btn btn-outline-secondary px-4 py-2">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prescription Modal -->
<div class="modal fade" id="prescriptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white border-0 py-3">
                <h5 class="modal-title fw-bold">Add Prescription</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label small fw-bold">Medication Name</label>
                    <input type="text" id="presc_name" class="form-control" placeholder="e.g. Amoxicillin">
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="form-label small fw-bold">Dosage</label>
                        <input type="text" id="presc_dosage" class="form-control" placeholder="e.g. 250mg">
                    </div>
                    <div class="col-6">
                        <label class="form-label small fw-bold">Frequency</label>
                        <input type="text" id="presc_freq" class="form-control" placeholder="e.g. Twice daily">
                    </div>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-12">
                        <label class="form-label small fw-bold">Duration</label>
                        <input type="text" id="presc_dur" class="form-control" placeholder="e.g. 7 days">
                    </div>
                </div>
                <div class="mb-0">
                    <label class="form-label small fw-bold">Instructions</label>
                    <textarea id="presc_inst" class="form-control" rows="2" placeholder="Take after food..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-4" id="addPrescriptionBtn">Add to Record</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Follow-up toggle
    const followUpCheck = document.querySelector('.form-check-input');
    const dateContainer = document.getElementById('follow_up_date_container');
    
    function toggleDate() {
        dateContainer.style.opacity = followUpCheck.checked ? '1' : '0.3';
        dateContainer.style.pointerEvents = followUpCheck.checked ? 'auto' : 'none';
    }
    
    followUpCheck.addEventListener('change', toggleDate);
    toggleDate();

    // Prescription Builder logic
    const prescriptions = [];
    const prescList = document.getElementById('prescription_list');
    const jsonInput = document.getElementById('prescriptions_json');
    const prescModalElem = document.getElementById('prescriptionModal');
    const modal = new bootstrap.Modal(prescModalElem);

    document.getElementById('addPrescriptionBtn').addEventListener('click', () => {
        const name = document.getElementById('presc_name').value;
        const dosage = document.getElementById('presc_dosage').value;
        const freq = document.getElementById('presc_freq').value;
        const dur = document.getElementById('presc_dur').value;
        const inst = document.getElementById('presc_inst').value;

        if (!name || !dosage) {
            alert('Please fill at least the medication name and dosage.');
            return;
        }

        const prescription = { name, dosage, frequency: freq, duration: dur, instructions: inst };
        prescriptions.push(prescription);
        renderPrescriptions();
        
        // Reset and hide
        document.getElementById('presc_name').value = '';
        document.getElementById('presc_dosage').value = '';
        document.getElementById('presc_freq').value = '';
        document.getElementById('presc_dur').value = '';
        document.getElementById('presc_inst').value = '';
        modal.hide();
    });

    function removePrescription(index) {
        prescriptions.splice(index, 1);
        renderPrescriptions();
    }

    function renderPrescriptions() {
        document.getElementById('no_prescriptions_msg').style.display = prescriptions.length ? 'none' : 'block';
        
        // Clear previous items
        const currentItems = prescList.querySelectorAll('.presc-item');
        currentItems.forEach(item => item.remove());

        prescriptions.forEach((p, index) => {
            const div = document.createElement('div');
            div.className = 'col-md-6 presc-item';
            div.innerHTML = `
                <div class="card border-0 shadow-sm p-3 position-relative" style="background-color: rgba(var(--bs-primary-rgb), 0.05) !important;">
                    <button type="button" class="btn-close position-absolute top-0 end-0 m-2" style="font-size: 0.7rem;" onclick="removePrescription(${index})"></button>
                    <div class="fw-bold text-primary">${p.name} <span class="badge bg-primary ms-1">${p.dosage}</span></div>
                    <div class="small text-secondary">${p.frequency} | ${p.duration}</div>
                    <div class="small mt-1 text-muted"><em>${p.instructions}</em></div>
                </div>
            `;
            prescList.appendChild(div);
        });

        jsonInput.value = JSON.stringify(prescriptions);
    }
</script>
{% endblock %}
{% endblock %}
